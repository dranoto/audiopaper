<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Turn research papers into audio podcasts">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AudioPaper">
    <title>AudioPaper</title>
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='icons/icon.svg') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon.svg') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=20260220c">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo">
                    <i class="bi bi-file-earmark-text"></i>
                    <span>AudioPaper</span>
                </div>
                <div class="header-actions">
                    <a href="{{ url_for('ragflow_browser') }}" class="btn btn-ghost" title="Ragflow Browser">
                        <i class="bi bi-collection-fill"></i>
                    </a>
                    <a href="{{ url_for('settings') }}" class="btn btn-ghost" title="Settings">
                        <i class="bi bi-gear"></i>
                    </a>
                </div>
            </div>
        </header>

        <main class="main-content">
            {% if not current_file %}
            <!-- Empty State / Upload - Show with library sidebar -->
            <div class="workflow-container">
                <div class="upload-section">
                    <div class="upload-card">
                        <div class="upload-icon">
                            <i class="bi bi-file-earmark-pdf"></i>
                        </div>
                        <h2>Upload a Research Paper</h2>
                        <p>Drop your PDF here or click to browse</p>
                        <form action="/upload" method="post" enctype="multipart/form-data" id="upload-form">
                            <input type="file" name="file" id="file-input" accept="application/pdf" hidden>
                            <button type="button" class="btn btn-primary btn-lg" onclick="document.getElementById('file-input').click()">
                                <i class="bi bi-upload"></i>
                                Choose PDF
                            </button>
                            
                            <div class="upload-options mt-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="upload_to_ragflow" name="upload_to_ragflow">
                                    <label class="form-check-label" for="upload_to_ragflow">
                                        Also upload to Ragflow
                                    </label>
                                </div>
                                <select class="form-select form-select-sm mt-2" name="ragflow_dataset" id="ragflow-dataset-select" style="display: none;">
                                    <option value="">Loading datasets...</option>
                                </select>
                            </div>
                        </form>
                        <p class="upload-hint">Supported: PDF files</p>
                    </div>
                </div>
                
                <!-- Library Sidebar (always visible) -->
                <div class="library-sidebar">
                    <h4>Library</h4>
                    {% if all_files %}
                    <div class="library-list">
                        {% for file in all_files %}
                        <a href="/?file={{ file.id }}" class="library-item">
                            <i class="bi bi-file-earmark-text"></i>
                            <span>{{ file.filename[:25] }}{% if file.filename|length > 25 %}...{% endif %}</span>
                            {% if file.summary %}<i class="bi bi-check-circle-fill text-success ms-auto"></i>{% endif %}
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted small">No papers yet</p>
                    {% endif %}
                    <a href="{{ url_for('ragflow_browser') }}" class="btn btn-outline w-100 mt-3">
                        <i class="bi bi-cloud-download"></i>
                        Import from Ragflow
                    </a>
                </div>

                <!-- Mobile Library Toggle (for upload page) -->
                <button class="btn btn-primary library-toggle" onclick="toggleLibrary()" title="Toggle Library">
                    <i class="bi bi-collection"></i>
                </button>
            </div>
            {% else %}
            <!-- Workflow View -->
            <div class="workflow-container">
                <!-- File Info Bar -->
                <div class="file-info-bar">
                    <div class="file-details">
                        <i class="bi bi-file-earmark-pdf"></i>
                        <span class="filename">{{ current_file.filename }}</span>
                    </div>
                    <div class="file-actions">
                        <button class="btn btn-ghost btn-sm" onclick="showOriginalText()" title="View Original Text">
                            <i class="bi bi-file-text"></i>
                        </button>
                        <button class="btn btn-ghost btn-sm text-danger" onclick="deleteFile({{ current_file.id }})" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                        <button class="btn btn-ghost btn-sm" onclick="window.location.href='/'">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>

                <!-- Step Indicator -->
                <div class="steps-indicator">
                    <div class="step {% if current_file.text %}completed{% elif current_file %}active{% endif %}">
                        <div class="step-number">1</div>
                        <div class="step-label">Ingest</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step {% if current_file.summary %}completed{% elif current_file and auto_generate %}active{% endif %}">
                        <div class="step-number">2</div>
                        <div class="step-label">Summary</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step {% if current_file.transcript %}completed{% endif %}">
                        <div class="step-number">3</div>
                        <div class="step-label">Script</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step {% if current_file.audio_exists %}completed{% endif %}">
                        <div class="step-number">4</div>
                        <div class="step-label">Audio</div>
                    </div>
                </div>

                <!-- Main Workflow Area -->
                <div class="workflow-content">
                    <!-- Progress state - always render so JavaScript can show/hide it -->
                    {% if current_file %}
                    <div class="workflow-step" id="inline-progress" style="display: none;">
                        <div class="step-header">
                            <h3><span class="step-num" id="progress-step-num">2</span> <span id="progress-title-text">Generating Summary</span></h3>
                        </div>
                        <div class="step-content">
                            <div class="inline-progress-container">
                                <div class="progress-steps-inline mb-3">
                                    <span class="step-dot active"></span>
                                    <span class="step-label">Ingest</span>
                                    <span class="step-line"></span>
                                    <span class="step-dot active"></span>
                                    <span class="step-label">Summary</span>
                                    <span class="step-line"></span>
                                    <span class="step-dot"></span>
                                    <span class="step-label">Script</span>
                                    <span class="step-line"></span>
                                    <span class="step-dot"></span>
                                    <span class="step-label">Audio</span>
                                </div>
                                <div class="progress-bar-container" style="max-width: 400px; margin: 0 auto;">
                                    <div id="inline-progress-bar" class="progress-bar" style="width: 10%;"></div>
                                </div>
                                <p id="progress-status-text" class="text-muted mt-2 text-center">Analyzing paper and creating summary...</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Regular workflow steps - hidden when inline progress is shown -->
                    <div id="workflow-steps-container">
                    <!-- No file selected - show library with options -->
                    {% if not current_file %}
                    <div class="workflow-step">
                        <div class="step-header">
                            <h3>Your Library</h3>
                        </div>
                        <div class="step-content">
                            {% if all_files %}
                            <p class="text-muted">Select a paper from the sidebar or upload a new one.</p>
                            {% else %}
                            <p class="text-muted">No papers yet. Upload a PDF or import from Ragflow.</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- File selected but no summary yet -->
                    {% if current_file and not current_file.summary and not auto_generate %}
                    <div class="workflow-step">
                        <div class="step-header">
                            <h3><span class="step-num">2</span> Summary</h3>
                        </div>
                        <div class="step-content">
                            <p class="text-muted">Summary not generated yet.</p>
                            <button class="btn btn-primary btn-lg w-100" id="btn-generate-summary" onclick="generateSummary()">
                                <i class="bi bi-lightning"></i>
                                Generate Summary
                            </button>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Step 2: Summary -->
                    {% if current_file.summary %}
                    <div class="workflow-step">
                        <div class="step-header">
                            <h3><span class="step-num">2</span> Summary</h3>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-ghost" onclick="showSummary()">View</button>
                                <button class="btn btn-sm btn-ghost" onclick="regenerateSummary()" title="Regenerate">
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>
                            </div>
                        </div>
                        <div class="step-content">
                            <div class="summary-preview">
                                {{ current_file.summary[:500] }}...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 3: Generate Podcast (after summary) -->
                    <div class="workflow-step">
                        <div class="step-header">
                            <h3><span class="step-num">3</span> Podcast Script</h3>
                            {% if current_file.transcript %}
                            <div class="btn-group">
                                <button class="btn btn-sm btn-ghost" onclick="showTranscript()">Edit</button>
                                <button class="btn btn-sm btn-ghost" onclick="regenerateTranscript()" title="Regenerate">
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                            {% if current_file.transcript %}
                            <div class="transcript-preview">
                                {{ current_file.transcript[:300] }}...
                            </div>
                            {% if current_file.audio_exists %}
                            <div class="mt-3 text-success">
                                <i class="bi bi-check-circle"></i> Audio ready!
                            </div>
                            {% else %}
                            <button class="btn btn-primary btn-lg w-100 mt-3" id="btn-generate-audio" onclick="generatePodcast()">
                                <i class="bi bi-play-circle"></i>
                                Generate Audio
                            </button>
                            {% endif %}
                            {% else %}
                            <button class="btn btn-primary btn-lg w-100 mt-3" id="btn-generate-transcript" onclick="generateTranscript()">
                                <i class="bi bi-chat-dots"></i>
                                Generate Podcast Script
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Step 4: Audio Ready -->
                    {% if current_file.audio_exists %}
                    <div class="workflow-step completed">
                        <div class="step-header">
                            <h3><span class="step-num">4</span> Audio Ready</h3>
                            <button class="btn btn-sm btn-ghost" onclick="showTranscript()">Edit Script</button>
                        </div>
                        <div class="step-content">
                            <div class="audio-player">
                                <audio controls class="w-100">
                                    <source src="{{ url_for('generated_audio', filename=current_file.audio_filename) }}" type="audio/mpeg">
                                    Your browser does not support audio.
                                </audio>
                            </div>
                            <div class="audio-actions">
                                <a href="{{ url_for('generated_audio', filename=current_file.audio_filename) }}" download class="btn btn-outline">
                                    <i class="bi bi-download"></i>
                                    Download
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Chat Section -->
                    <div class="workflow-step">
                        <div class="step-header">
                            <h3><i class="bi bi-chat-dots"></i> Chat with Document</h3>
                        </div>
                        <div class="step-content">
                            <button class="btn btn-outline w-100" onclick="openChat()">
                                <i class="bi bi-chat"></i>
                                Open Chat
                            </button>
                        </div>
                    </div>
                    </div><!-- End workflow-steps-container -->

                    <!-- Loading States -->
                    <div id="loading-overlay" class="loading-overlay" style="display: none;">
                        <div class="spinner"></div>
                        <p id="loading-text">Processing...</p>
                    </div>

                    <!-- Progress Modal -->
                    <div id="progress-modal" class="progress-modal hidden">
                        <div class="progress-card">
                            <div id="progress-icon" class="progress-icon processing">
                                <i class="bi bi-hourglass-split"></i>
                            </div>
                            <h3 id="progress-title" class="progress-title">Processing...</h3>
                            <p id="progress-subtitle" class="progress-subtitle">Please wait</p>
                            <div class="progress-steps" id="progress-steps">
                                <div class="progress-step active" data-step="1" title="Ingest"></div>
                                <div class="progress-step" data-step="2" title="Summary"></div>
                                <div class="progress-step" data-step="3" title="Script"></div>
                                <div class="progress-step" data-step="4" title="Audio"></div>
                            </div>
                            <div class="progress-bar-container">
                                <div id="progress-bar" class="progress-bar"></div>
                            </div>
                            <p id="progress-status" class="text-muted small">Step 1 of 4</p>
                            <button id="progress-cancel" class="btn btn-ghost btn-sm mt-3" onclick="cancelCurrentTask()">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sidebar: File Library -->
                <div class="library-sidebar">
                    <h4>Library</h4>
                    <div class="library-list">
                        {% for file in all_files %}
                        <div class="library-item-row">
                            <a href="/?file={{ file.id }}" class="library-item {% if file.id == current_file.id %}active{% endif %}">
                                <i class="bi bi-file-earmark-text"></i>
                                <span>{{ file.filename[:18] }}{% if file.filename|length > 18 %}...{% endif %}</span>
                                {% if file.summary %}<i class="bi bi-check-circle-fill text-success ms-auto" title="Summary ready"></i>{% endif %}
                            </a>
                            <button class="btn btn-ghost btn-sm library-delete" onclick="event.preventDefault(); deleteFile({{ file.id }})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    <a href="{{ url_for('ragflow_browser') }}" class="btn btn-outline w-100 mt-3">
                        <i class="bi bi-cloud-download"></i>
                        Import from Ragflow
                    </a>
                    <button class="btn btn-outline w-100 mt-2" onclick="window.location.href='/'">
                        <i class="bi bi-plus-lg"></i>
                        New Upload
                    </button>
                </div>

                <!-- Mobile Library Toggle -->
                <button class="btn btn-primary library-toggle" onclick="toggleLibrary()" title="Toggle Library">
                    <i class="bi bi-collection"></i>
                </button>
            </div>
            {% endif %}
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="summary-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Summary</h3>
                <button class="btn btn-ghost" onclick="closeModal('summary-modal')">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="summary-text">{{ current_file.summary if current_file.summary else 'No summary yet.' }}</div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="original-text-modal" style="display: none;">
        <div class="modal-content modal-lg" style="max-width: 900px;">
            <div class="modal-header">
                <h3>Original Text</h3>
                <button class="btn btn-ghost" onclick="closeModal('original-text-modal')">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body" style="white-space: pre-wrap; font-size: 13px; line-height: 1.6;">
                <div id="original-text-content">{{ current_file.text }}</div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="transcript-modal" style="display: none;">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3>Podcast Script</h3>
                <button class="btn btn-ghost" onclick="closeModal('transcript-modal')">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="transcript-edit" rows="15">{{ current_file.transcript if current_file.transcript else '' }}</textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveAndGenerate()">
                    <i class="bi bi-play-circle"></i>
                    Save & Generate Audio
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div class="modal-overlay" id="chat-modal" style="display: none;">
        <div class="modal-content modal-lg" style="max-width: 700px; height: 80vh;">
            <div class="modal-header">
                <h3><i class="bi bi-chat-dots"></i> Chat with Document</h3>
                <button class="btn btn-ghost" onclick="closeModal('chat-modal')">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; padding: 0;">
                <div class="chat-options" style="padding: 12px 20px; border-bottom: 1px solid var(--border);">
                    <label class="chat-toggle">
                        <input type="checkbox" id="ragflow-toggle">
                        <span>Include Ragflow context</span>
                    </label>
                    <select id="ragflow-dataset" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                        <option value="">Loading datasets...</option>
                    </select>
                </div>
                <div id="chat-messages" class="chat-messages" style="flex: 1; overflow-y: auto; padding: 20px;">
                    <div class="chat-message assistant">
                        <p>Ask me anything about this document. I can also pull relevant context from your Ragflow knowledge base if enabled.</p>
                    </div>
                </div>
                <div class="chat-input-container" style="padding: 16px 20px; border-top: 1px solid var(--border);">
                    <div class="input-group">
                        <input type="text" id="chat-input" class="form-control" placeholder="Ask a question about this document..." onkeypress="if(event.key==='Enter')sendChat()">
                        <button class="btn btn-primary" onclick="sendChat()">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}?v=20260220b"></script>
    <script>
        // Load Ragflow datasets for upload dropdown
        fetch('/ragflow/datasets')
            .then(r => r.json())
            .then(data => {
                const select = document.getElementById('ragflow-dataset-select');
                if (select && data.datasets) {
                    select.innerHTML = data.datasets.map(d =>
                        `<option value="${d.id}">${d.name}</option>`
                    ).join('');
                }
            });
        
        // Toggle ragflow dataset dropdown
        document.getElementById('upload_to_ragflow')?.addEventListener('change', function() {
            const select = document.getElementById('ragflow-dataset-select');
            if (select) select.style.display = this.checked ? 'block' : 'none';
        });

        // File input handler
        document.getElementById('file-input')?.addEventListener('change', function() {
            if (this.files.length > 0) {
                document.getElementById('upload-form').submit();
            }
        });

        // Mobile library toggle
        function toggleLibrary() {
            // Toggle all library sidebar elements
            document.querySelectorAll('.library-sidebar').forEach(sidebar => {
                if (sidebar.classList.contains('visible')) {
                    sidebar.classList.remove('visible');
                    sidebar.classList.add('collapsed');
                } else if (sidebar.classList.contains('collapsed')) {
                    sidebar.classList.remove('collapsed');
                    sidebar.classList.add('visible');
                } else {
                    // If neither class is present, show it
                    sidebar.classList.add('visible');
                }
            });
        }

        // Initialize mobile library - start hidden, user taps button to see
        if (window.innerWidth <= 768) {
            document.querySelectorAll('.library-sidebar').forEach(sidebar => {
                sidebar.classList.remove('visible');
                sidebar.classList.add('collapsed');
            });
        }

        // Global flag for inline mode - must be defined first
        let globalInlineMode = new URL(window.location).searchParams.get('inline') === 'true';
        let isGenerating = false;  // Flag to prevent multiple concurrent generation tasks

        // Task step map - defined early for use by pollTask
        const taskStepMap = {
            'summary': { step: 2, name: 'Summary', icon: 'bi-card-text' },
            'transcript': { step: 3, name: 'Script', icon: 'bi-chat-dots' },
            'podcast': { step: 4, name: 'Audio', icon: 'bi-headphones' }
        };

        // Auto-generate summary on page load if requested (from import)
        const autoGenerate = '{{ auto_generate }}' !== 'None' ? '{{ auto_generate }}' : null;
        const currentFileHasSummary = {{ 'true' if current_file and current_file.summary else 'false' }};

        // Use streaming for auto-generation
        if (autoGenerate === 'summary' && !currentFileHasSummary) {
            // Set inline mode and start streaming
            globalInlineMode = true;
            // Clear the URL params
            const url = new URL(window.location);
            url.searchParams.delete('generate');
            url.searchParams.delete('inline');
            window.history.replaceState({}, '', url.toString());

            // Start streaming after a brief delay to let page render
            setTimeout(() => streamSummary(), 500);
        } else if (currentFileHasSummary && autoGenerate) {
            // Summary already exists, just clear the param from URL
            const url = new URL(window.location);
            url.searchParams.delete('generate');
            url.searchParams.delete('inline');
            window.history.replaceState({}, '', url.toString());
        }

        // Streaming support using SSE
        let currentEventSource = null;

        function streamSummary() {
            // Prevent multiple concurrent generation tasks
            if (isGenerating) return;
            isGenerating = true;

            // Disable the button
            const btn = document.getElementById('btn-generate-summary');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
            }

            globalInlineMode = true;
            showLoading('Generating summary...');
            
            // Close any existing stream
            if (currentEventSource) {
                currentEventSource.close();
            }
            
            const statusEl = document.getElementById('progress-status-text');
            const barEl = document.getElementById('inline-progress-bar');
            let fullText = '';
            
            currentEventSource = new EventSource('/summarize_stream/{{ current_file.id }}');
            
            currentEventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'token') {
                    fullText += data.content;
                    // Update progress based on text length (simulated)
                    if (barEl && fullText.length > 50) {
                        const progress = Math.min(10 + (fullText.length / 10), 90);
                        barEl.style.width = progress + '%';
                    }
                    if (statusEl) {
                        statusEl.textContent = `Generating... ${fullText.length} chars`;
                    }
                } else if (data.type === 'complete') {
                    currentEventSource.close();
                    currentEventSource = null;
                    if (barEl) {
                        barEl.className = 'progress-bar success';
                        barEl.style.width = '100%';
                    }
                    if (statusEl) statusEl.textContent = 'Complete! Loading...';
                    setTimeout(() => window.location.reload(), 1000);
                } else if (data.type === 'error') {
                    currentEventSource.close();
                    currentEventSource = null;
                    isGenerating = false;
                    resetGenerateButton('summary');
                    showInlineError('summary', data.error);
                }
            };
            
            currentEventSource.onerror = function() {
                currentEventSource.close();
                currentEventSource = null;
                showInlineError('summary', 'Connection error');
            };
        }

        function streamTranscript() {
            // Prevent multiple concurrent generation tasks
            if (isGenerating) return;
            isGenerating = true;

            // Disable the button
            const btn = document.getElementById('btn-generate-transcript');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
            }

            globalInlineMode = true;
            showLoading('Creating podcast script...', 'transcript');
            
            if (currentEventSource) {
                currentEventSource.close();
            }
            
            const statusEl = document.getElementById('progress-status-text');
            const barEl = document.getElementById('inline-progress-bar');
            let fullText = '';
            
            currentEventSource = new EventSource('/transcript_stream/{{ current_file.id }}');
            
            currentEventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'token') {
                    fullText += data.content;
                    if (barEl && fullText.length > 50) {
                        const progress = Math.min(10 + (fullText.length / 10), 90);
                        barEl.style.width = progress + '%';
                    }
                    if (statusEl) {
                        statusEl.textContent = `Generating script... ${fullText.length} chars`;
                    }
                } else if (data.type === 'complete') {
                    currentEventSource.close();
                    currentEventSource = null;
                    if (barEl) {
                        barEl.className = 'progress-bar success';
                        barEl.style.width = '100%';
                    }
                    if (statusEl) statusEl.textContent = 'Complete! Loading...';
                    setTimeout(() => window.location.reload(), 1000);
                } else if (data.type === 'error') {
                    currentEventSource.close();
                    currentEventSource = null;
                    isGenerating = false;
                    resetGenerateButton('transcript');
                    showInlineError('transcript', data.error);
                }
            };

            currentEventSource.onerror = function() {
                currentEventSource.close();
                currentEventSource = null;
                isGenerating = false;
                resetGenerateButton('transcript');
                showInlineError('transcript', 'Connection error');
            };
        }

        // Helper to reset generate button after error
        function resetGenerateButton(type) {
            let btnId = null;
            if (type === 'summary') btnId = 'btn-generate-summary';
            else if (type === 'transcript') btnId = 'btn-generate-transcript';
            else if (type === 'podcast') btnId = 'btn-generate-audio';

            if (btnId) {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.disabled = false;
                    // Reset button text based on type
                    if (type === 'summary') {
                        btn.innerHTML = '<i class="bi bi-lightning"></i> Generate Summary';
                    } else if (type === 'transcript') {
                        btn.innerHTML = '<i class="bi bi-chat-dots"></i> Generate Podcast Script';
                    } else if (type === 'podcast') {
                        btn.innerHTML = '<i class="bi bi-play-circle"></i> Generate Audio';
                    }
                }
            }
            isGenerating = false;
        }

        // Legacy workflow functions (keep for podcast which doesn't have streaming yet)
        function generateSummary() {
            streamSummary();
        }

        function generatePodcast() {
            // Prevent multiple concurrent generation tasks
            if (isGenerating) return;
            isGenerating = true;

            // Disable the button
            const btn = document.getElementById('btn-generate-audio');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
            }

            globalInlineMode = true;
            showLoading('Generating podcast audio...', 'podcast');

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000);

            fetch('/generate_podcast/{{ current_file.id }}', {
                method: 'POST',
                signal: controller.signal
            })
            .then(r => {
                clearTimeout(timeoutId);
                if (!r.ok) throw new Error('HTTP ' + r.status);
                return r.json();
            })
            .then(data => pollTask(data.task_id, 'podcast', true))
            .catch(err => {
                clearTimeout(timeoutId);
                console.error('Generate podcast error:', err);
                isGenerating = false;
                resetGenerateButton('podcast');
                alert('Error: ' + err.message);
            });
        }

        function generateTranscript() {
            streamTranscript();
        }

        function regenerateSummary() {
            if (!confirm('Regenerate summary?')) return;
            streamSummary();
        }

        function regenerateTranscript() {
            if (!confirm('Regenerate podcast script?')) return;
            streamTranscript();
        }

        function deleteFile(fileId) {
            if (!confirm('Delete this paper? This will remove the summary, transcript, and any generated audio.')) return;
            
            fetch(`/delete_file/${fileId}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                    } else {
                        window.location.href = '/';
                    }
                })
                .catch(err => alert('Error: ' + err));
        }

        function showSummary() {
            // Render markdown
            const el = document.getElementById('summary-text');
            if (el && typeof marked !== 'undefined') {
                el.innerHTML = marked.parse(el.textContent || el.innerText);
            }
            document.getElementById('summary-modal').style.display = 'flex';
        }

        function showOriginalText() {
            document.getElementById('original-text-modal').style.display = 'flex';
        }

        function showTranscript() {
            document.getElementById('transcript-modal').style.display = 'flex';
        }

        function saveAndGenerate() {
            const transcript = document.getElementById('transcript-edit').value;
            
            // Save the transcript first
            fetch('/save_transcript/{{ current_file.id }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ transcript: transcript })
            })
            .then(r => r.json())
            .then(data => {
                closeModal('transcript-modal');
                generatePodcast();
            })
            .catch(err => {
                alert('Error saving transcript: ' + err);
            });
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        let currentTaskInterval = null;

        function showProgressModal(taskType, message) {
            // If inline mode, try inline first but don't recurse back
            if (globalInlineMode) {
                const inlineDiv = document.getElementById('inline-progress');
                if (inlineDiv !== null) {
                    // Inline elements exist - use showLoading which handles this
                    showLoading(message, taskType);
                    return;
                }
                // Inline elements don't exist - fall through to modal (don't recurse)
            }
            
            const modal = document.getElementById('progress-modal');
            const title = document.getElementById('progress-title');
            const subtitle = document.getElementById('progress-subtitle');
            const icon = document.getElementById('progress-icon');
            const bar = document.getElementById('progress-bar');
            const status = document.getElementById('progress-status');
            const cancelBtn = document.getElementById('progress-cancel');
            const steps = document.querySelectorAll('.progress-step');

            const taskInfo = taskStepMap[taskType] || { step: 1, name: taskType, icon: 'bi-gear' };

            // Update title and subtitle
            title.textContent = message || `Generating ${taskInfo.name}...`;
            subtitle.textContent = taskInfo.name;

            // Set icon
            icon.className = 'progress-icon processing';
            icon.innerHTML = `<i class="bi ${taskInfo.icon}"></i>`;

            // Reset progress
            bar.className = 'progress-bar';
            bar.style.width = '10%';

            // Update step indicators
            steps.forEach((s, i) => {
                s.className = 'progress-step';
                if (i + 1 < taskInfo.step) {
                    s.classList.add('completed');
                } else if (i + 1 === taskInfo.step) {
                    s.classList.add('active');
                }
            });

            status.textContent = `Step ${taskInfo.step} of 4`;
            cancelBtn.style.display = 'inline-flex';

            modal.classList.remove('hidden');
        }

        function updateProgress(taskType, progress, message) {
            const bar = document.getElementById('progress-bar');
            const title = document.getElementById('progress-title');
            const status = document.getElementById('progress-status');

            if (progress !== undefined) {
                bar.style.width = progress + '%';
            }
            if (message) {
                title.textContent = message;
            }
        }

        function showProgressSuccess(taskType) {
            const modal = document.getElementById('progress-modal');
            const title = document.getElementById('progress-title');
            const subtitle = document.getElementById('progress-subtitle');
            const icon = document.getElementById('progress-icon');
            const bar = document.getElementById('progress-bar');
            const cancelBtn = document.getElementById('progress-cancel');

            const taskInfo = taskStepMap[taskType] || { step: 1, name: taskType };

            title.textContent = `${taskInfo.name} Complete!`;
            subtitle.textContent = 'Redirecting...';
            icon.className = 'progress-icon success';
            icon.innerHTML = '<i class="bi bi-check-lg"></i>';
            bar.className = 'progress-bar success';
            bar.style.width = '100%';
            cancelBtn.style.display = 'none';

            // Auto close and redirect WITHOUT task_id to break the polling loop
            setTimeout(() => {
                modal.classList.add('hidden');
                // Get current file_id from URL (if any) but strip task_id
                const url = new URL(window.location);
                const fileId = url.searchParams.get('file');
                const newUrl = fileId ? `/?file=${fileId}` : '/';
                window.location.href = newUrl;
            }, 1500);
        }

        function showProgressError(taskType, error) {
            const modal = document.getElementById('progress-modal');
            const title = document.getElementById('progress-title');
            const subtitle = document.getElementById('progress-subtitle');
            const icon = document.getElementById('progress-icon');
            const bar = document.getElementById('progress-bar');
            const cancelBtn = document.getElementById('progress-cancel');

            const taskInfo = taskStepMap[taskType] || { step: 1, name: taskType };

            title.textContent = 'Error';
            subtitle.textContent = error || 'An error occurred';
            icon.className = 'progress-icon error';
            icon.innerHTML = '<i class="bi bi-exclamation-lg"></i>';
            bar.className = 'progress-bar error';
            bar.style.width = '100%';
            cancelBtn.textContent = 'Close';
            cancelBtn.onclick = () => modal.classList.add('hidden');
        }

        function hideProgressModal() {
            document.getElementById('progress-modal').classList.add('hidden');
        }

        function showLoading(text, type = 'summary') {
            // Check if inline progress elements exist
            const inlineDiv = document.getElementById('inline-progress');
            const hasInlineElements = inlineDiv !== null;

            // If inline mode but elements don't exist, fall back to modal
            const useInline = globalInlineMode && hasInlineElements;

            if (useInline) {
                // Only hide workflow steps for summary generation, not for transcript/podcast
                if (type === 'summary') {
                    const workflowSteps = document.getElementById('workflow-steps-container');
                    if (workflowSteps) workflowSteps.style.display = 'none';
                }

                // Update step number and labels based on task type
                const stepNumEl = document.getElementById('progress-step-num');
                const titleEl = document.getElementById('progress-title-text');
                const statusEl = document.getElementById('progress-status-text');
                const barEl = document.getElementById('inline-progress-bar');

                // Get task info from taskStepMap
                const taskInfo = taskStepMap[type] || { step: 2, name: type };

                if (stepNumEl) stepNumEl.textContent = taskInfo.step;
                if (titleEl) titleEl.textContent = text;
                if (statusEl) statusEl.textContent = 'Please wait...';
                if (barEl) {
                    barEl.classList.remove('success', 'error');
                    barEl.style.width = '10%';
                }

                // Also ensure inline progress is visible
                if (inlineDiv) {
                    inlineDiv.style.display = 'block';
                }

                // Hide modal if open
                const modal = document.getElementById('progress-modal');
                if (modal) modal.classList.add('hidden');
                return;
            }

            // Otherwise use modal
            showProgressModal(type, text);
        }

        function showWorkflowSteps() {
            const workflowSteps = document.getElementById('workflow-steps-container');
            if (workflowSteps) workflowSteps.style.display = 'block';
        }

        function hideLoading() {
            // Legacy - now handled by progress modal
        }

        function cancelCurrentTask() {
            if (currentTaskInterval) {
                clearInterval(currentTaskInterval);
                currentTaskInterval = null;
            }
            hideProgressModal();
        }

        function pollTask(taskId, type, inline = null) {
            // Use global inline mode if not explicitly specified
            if (inline === null) {
                inline = globalInlineMode;
            }
            
            const statusType = (type === 'summary') ? 'summarize' : type;
            
            // Check if inline elements exist, fall back to modal if not
            const hasInlineElements = document.getElementById('inline-progress') !== null;
            if (inline && !hasInlineElements) {
                inline = false;
            }

            // Show progress - inline or modal based on mode
            if (inline) {
                // Inline mode - update the inline progress in workflow area
                // Hide workflow steps for summary generation
                if (type === 'summary') {
                    const workflowSteps = document.getElementById('workflow-steps-container');
                    if (workflowSteps) workflowSteps.style.display = 'none';
                }

                // Show inline-progress div
                const inlineDiv = document.getElementById('inline-progress');
                if (inlineDiv) inlineDiv.style.display = 'block';

                // Update step number based on task type
                const stepNumEl = document.getElementById('progress-step-num');
                const taskInfo = taskStepMap[type] || { step: 2, name: type };
                if (stepNumEl) stepNumEl.textContent = taskInfo.step;

                const titleEl = document.getElementById('progress-title-text');
                const statusEl = document.getElementById('progress-status-text');
                const barEl = document.getElementById('inline-progress-bar');
                if (titleEl) titleEl.textContent = `Generating ${taskStepMap[type]?.name || type}...`;
                if (statusEl) statusEl.textContent = 'Please wait while we analyze the paper...';
                if (barEl) barEl.style.width = '10%';
            } else {
                // Modal mode - show the progress modal
                showProgressModal(type, `Generating ${taskStepMap[type]?.name || type}...`);
            }

            currentTaskInterval = setInterval(() => {
                fetch('/' + statusType + '_status/' + taskId)
                    .then(r => r.json())
                    .then(data => {
                        if (data.status === 'complete') {
                            clearInterval(currentTaskInterval);
                            currentTaskInterval = null;
                            if (inline) {
                                showInlineSuccess(type);
                            } else {
                                showProgressSuccess(type);
                            }
                        } else if (data.status === 'error') {
                            clearInterval(currentTaskInterval);
                            currentTaskInterval = null;
                            if (inline) {
                                showInlineError(type, data.result?.error || 'Unknown error');
                            } else {
                                showProgressError(type, data.result?.error || 'Unknown error');
                            }
                        } else {
                            // Update progress
                            if (inline) {
                                const barEl = document.getElementById('inline-progress-bar');
                                const current = parseInt(barEl?.style.width) || 10;
                                if (barEl && current < 85) {
                                    barEl.style.width = (current + 15) + '%';
                                }
                            } else {
                                const current = parseInt(document.getElementById('progress-bar')?.style.width) || 10;
                                if (current < 90) {
                                    updateProgress(type, Math.min(current + 15, 85));
                                }
                            }
                        }
                    })
                    .catch(err => {
                        clearInterval(currentTaskInterval);
                        currentTaskInterval = null;
                        if (inline) {
                            showInlineError(type, 'Connection error');
                        } else {
                            showProgressError(type, 'Connection error');
                        }
                    });
            }, 3000);
        }

        function showInlineSuccess(taskType) {
            const barEl = document.getElementById('inline-progress-bar');
            const titleEl = document.getElementById('progress-title-text');
            const statusEl = document.getElementById('progress-status-text');
            
            if (barEl) {
                barEl.className = 'progress-bar success';
                barEl.style.width = '100%';
            }
            if (titleEl) titleEl.textContent = 'Summary Complete!';
            if (statusEl) statusEl.textContent = 'Loading your paper...';
            
            // Clear URL params and reload
            setTimeout(() => {
                const url = new URL(window.location);
                url.searchParams.delete('task_id');
                url.searchParams.delete('inline');
                window.location.href = url.toString();
            }, 1500);
        }

        function showInlineError(taskType, error) {
            const barEl = document.getElementById('inline-progress-bar');
            const titleEl = document.getElementById('progress-title-text');
            const statusEl = document.getElementById('progress-status-text');
            
            if (barEl) {
                barEl.className = 'progress-bar error';
                barEl.style.width = '100%';
            }
            if (titleEl) titleEl.textContent = 'Error';
            if (statusEl) statusEl.textContent = error;
            
            // Add retry button
            const container = document.querySelector('.inline-progress-container');
            if (container) {
                const retryBtn = document.createElement('button');
                retryBtn.className = 'btn btn-primary mt-2';
                retryBtn.textContent = 'Try Again';
                retryBtn.onclick = () => window.location.reload();
                container.appendChild(retryBtn);
            }
        }

        // Chat functions
        let chatFileId = {{ current_file.id if current_file else 'null' }};
        
        function openChat() {
            document.getElementById('chat-modal').style.display = 'flex';
            loadRagflowDatasets();
        }

        function loadRagflowDatasets() {
            fetch('/ragflow/datasets')
                .then(r => r.json())
                .then(data => {
                    const select = document.getElementById('ragflow-dataset');
                    if (data.error) {
                        select.innerHTML = '<option value="">Ragflow not configured</option>';
                        return;
                    }
                    select.innerHTML = '<option value="">Select dataset...</option>' +
                        data.datasets.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
                })
                .catch(() => {
                    document.getElementById('ragflow-dataset').innerHTML = '<option value="">Ragflow error</option>';
                });
        }

        function sendChat() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            const useRagflow = document.getElementById('ragflow-toggle').checked;
            const datasetId = document.getElementById('ragflow-dataset').value;

            // Add user message to chat
            addMessage('user', message);
            input.value = '';

            // Show typing indicator
            const messagesDiv = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message assistant typing';
            typingDiv.innerHTML = '<p><i class="bi bi-three-dots"></i> Thinking...</p>';
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            fetch(`/chat_file/${chatFileId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    message: message,
                    use_ragflow: useRagflow,
                    ragflow_dataset_id: datasetId || null
                })
            })
            .then(r => r.json())
            .then(data => {
                typingDiv.remove();
                if (data.error) {
                    addMessage('assistant', 'Error: ' + data.error);
                } else {
                    if (data.ragflow_used) {
                        addMessage('assistant', data.message + '\n\n<small><i class="bi bi-info-circle"></i> Used Ragflow context</small>');
                    } else {
                        addMessage('assistant', data.message);
                    }
                }
            })
            .catch(err => {
                typingDiv.remove();
                addMessage('assistant', 'Error: ' + err);
            });
        }

        function addMessage(role, content) {
            const messagesDiv = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `chat-message ${role}`;
            div.innerHTML = `<p>${content.replace(/\n/g, '<br>')}</p>`;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('{{ url_for("static", filename="service-worker.js") }}')
                    .then((registration) => {
                        console.log('AudioPaper SW registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('AudioPaper SW registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
