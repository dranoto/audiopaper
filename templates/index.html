{% extends "base.html" %}

{% block title %}AudioPaper{% endblock %}

{% block header_actions %}
<div class="header-actions">
    <button class="btn btn-ghost" id="sidebar-toggle" title="Toggle Sidebar">
        <i class="bi bi-layout-sidebar"></i>
    </button>
    <a href="{{ url_for('ragflow.ragflow_browser') }}" class="btn btn-ghost" title="Ragflow Browser">
        <i class="bi bi-collection-fill"></i>
    </a>
    <a href="{{ url_for('settings.settings') }}" class="btn btn-ghost" title="Settings">
        <i class="bi bi-gear"></i>
    </a>
</div>
{% endblock %}

{% block content %}
{% if not current_file %}
<div class="workflow-container">
    <div id="main-content">
        <div class="upload-section">
        <div class="upload-card">
            <div class="upload-icon">
                <i class="bi bi-file-earmark-pdf"></i>
            </div>
            <h2>Upload a Research Paper</h2>
            <p>Drop your PDF here or click to browse</p>
            
            <div class="dropzone" id="dropzone">
                <div class="dropzone-content">
                    <i class="bi bi-cloud-arrow-up"></i>
                    <span>Drag & drop your PDF here</span>
                    <small>or</small>
                </div>
                <form action="{{ url_for('files.upload_file') }}" method="post" enctype="multipart/form-data" id="upload-form">
                    <input type="file" name="file" id="file-input" accept="application/pdf" hidden>
                    <button type="button" class="btn btn-primary btn-lg" onclick="document.getElementById('file-input').click()">
                        <i class="bi bi-upload"></i>
                        Choose PDF
                    </button>
                </form>
            </div>
            
            <div class="upload-progress-container" id="upload-progress" style="display: none;">
                <div class="upload-progress-info">
                    <span class="upload-filename" id="upload-filename"></span>
                    <span class="upload-percentage" id="upload-percentage">0%</span>
                </div>
                <div class="upload-progress-bar">
                    <div class="upload-progress-fill" id="upload-progress-fill"></div>
                </div>
                <button class="btn btn-ghost btn-sm" onclick="cancelUpload()" id="upload-cancel">
                    <i class="bi bi-x-lg"></i> Cancel
                </button>
            </div>
            
            <div class="upload-options mt-3">
                <label class="form-label">
                    <i class="bi bi-collection"></i> Upload to Ragflow Dataset:
                </label>
                <select class="form-select form-select-sm" name="ragflow_dataset" id="ragflow-dataset-select" required>
                    <option value="">Select a dataset...</option>
                </select>
                <small class="text-muted d-block mt-1">Select a dataset to enable Ragflow chat features</small>
            </div>
            <p class="upload-hint">Supported: PDF files (will be uploaded to Ragflow for AI features)</p>
        </div>
    </div>
    
    <div id="sidebar" class="library-sidebar">
        <h4>Library</h4>
        {% if all_files %}
        <div class="library-list">
            {% for file in all_files %}
            <a href="/?file={{ file.id }}" class="library-item">
                <i class="bi bi-file-earmark-text"></i>
                <span>{{ file.filename[:25] }}{% if file.filename|length > 25 %}...{% endif %}</span>
                {% if file.summary %}<i class="bi bi-check-circle-fill text-success ms-auto"></i>{% endif %}
            </a>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted small">No papers yet</p>
        {% endif %}
        <a href="{{ url_for('ragflow.ragflow_browser') }}" class="btn btn-outline w-100 mt-3">
            <i class="bi bi-cloud-download"></i>
            Import from Ragflow
        </a>
    </div>
</div>
{% else %}
<div class="workflow-container">
    <div id="main-content">
    <div class="file-info-bar">
        <div class="file-details">
            <i class="bi bi-file-earmark-pdf"></i>
            <span class="filename">{{ current_file.filename }}</span>
        </div>
        <div class="file-actions">
            <button class="btn btn-ghost btn-sm" onclick="showOriginalText()" title="View Original Text">
                <i class="bi bi-file-text"></i>
            </button>
            <button class="btn btn-ghost btn-sm text-danger" onclick="deleteFile({{ current_file.id }})" title="Delete">
                <i class="bi bi-trash"></i>
            </button>
            <button class="btn btn-ghost btn-sm" onclick="window.location.href='/'">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </div>

    <div class="steps-indicator" role="navigation" aria-label="Workflow progress">
        <div class="step {% if current_file.text %}completed{% elif current_file %}active{% endif %}" title="Step 1: PDF is uploaded and text is extracted" aria-label="Step 1 Ingest: Complete">
            <div class="step-number">1</div>
            <div class="step-label">Ingest</div>
        </div>
        <div class="step-line"></div>
        <div class="step {% if current_file.summary %}completed{% elif current_file and auto_generate %}active{% endif %}" title="Step 2: AI generates a summary of the paper" aria-label="Step 2 Summary: Generate summary">
            <div class="step-number">2</div>
            <div class="step-label">Summary</div>
        </div>
        <div class="step-line"></div>
        <div class="step {% if current_file.transcript %}completed{% endif %}" title="Step 3: AI creates a podcast script" aria-label="Step 3 Script: Generate podcast script">
            <div class="step-number">3</div>
            <div class="step-label">Script</div>
        </div>
        <div class="step-line"></div>
        <div class="step {% if current_file.audio_exists %}completed{% endif %}" title="Step 4: Convert script to audio podcast" aria-label="Step 4 Audio: Generate audio">
            <div class="step-number">4</div>
            <div class="step-label">Audio</div>
        </div>
    </div>

    <div class="workflow-content">
        {% if current_file %}
        <div class="workflow-step" id="inline-progress" style="display: none;">
            <div class="step-header">
                <h3><span class="step-num" id="progress-step-num">2</span> <span id="progress-title-text">Generating Summary</span></h3>
            </div>
            <div class="step-content">
                <div class="inline-progress-container active" id="inline-progress-container">
                    <div class="spinner"></div>
                    <p class="progress-status" id="progress-status-text">Analyzing paper and creating summary...</p>
                    <div class="progress-bar-container" style="max-width: 400px; margin: 0 auto;">
                        <div id="inline-progress-bar" class="progress-bar" style="width: 10%;"></div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div id="workflow-steps-container">
            {% if not current_file %}
            <div class="workflow-step">
                <div class="step-header">
                    <h3>Your Library</h3>
                </div>
                <div class="step-content">
                    {% if all_files %}
                    <p class="text-muted">Select a paper from the sidebar or upload a new one.</p>
                    {% else %}
                    <div class="empty-state">
                        <i class="bi bi-file-earmark-text"></i>
                        <h4>No papers yet</h4>
                        <p>Get started by uploading a PDF or importing from Ragflow</p>
                        <div class="empty-state-actions">
                            <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                                <i class="bi bi-upload"></i> Upload PDF
                            </button>
                            <a href="{{ url_for('ragflow.ragflow_browser') }}" class="btn btn-outline">
                                <i class="bi bi-cloud-download"></i> Import from Ragflow
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if current_file and not current_file.summary and not auto_generate %}
            <div class="workflow-step">
                <div class="step-header">
                    <h3><span class="step-num">2</span> Summary</h3>
                </div>
                <div class="step-content">
                    <p class="text-muted">Summary not generated yet.</p>
                    <button class="btn btn-primary btn-lg w-100" id="btn-generate-summary" onclick="generateSummary()">
                        <i class="bi bi-lightning"></i>
                        Generate Summary
                    </button>
                </div>
            </div>
            {% endif %}

            {% if current_file.summary %}
            <div class="workflow-step">
                <div class="step-header">
                    <h3><span class="step-num">2</span> Summary</h3>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-ghost" onclick="regenerateSummary()" title="Regenerate">
                            <i class="bi bi-arrow-repeat"></i>
                        </button>
                    </div>
                </div>
                <div class="step-content">
                    <div class="content-display summary-display" data-markdown="{{ current_file.summary|e }}">
                        {{ current_file.summary }}
                    </div>
                </div>
            </div>
            
            <div class="workflow-step">
                <div class="step-header">
                    <h3><span class="step-num">3</span> Podcast Script</h3>
                    {% if current_file.transcript %}
                    <div class="btn-group">
                        <button class="btn btn-sm btn-ghost" onclick="showTranscript()">Edit</button>
                        <button class="btn btn-sm btn-ghost" onclick="regenerateTranscript()" title="Regenerate">
                            <i class="bi bi-arrow-repeat"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% if current_file.transcript %}
                <div class="content-display transcript-display" data-markdown="{{ current_file.transcript|e }}">
                    {{ current_file.transcript }}
                </div>
                {% if current_file.audio_exists %}
                <div class="mt-3 text-success">
                    <i class="bi bi-check-circle"></i> Audio ready!
                </div>
                {% else %}
                <button class="btn btn-cta mt-3" id="btn-generate-audio" onclick="generatePodcast()">
                    <i class="bi bi-play-circle"></i>
                    Generate Audio
                </button>
                {% endif %}
                {% else %}
                <button class="btn btn-primary btn-lg w-100 mt-3" id="btn-generate-transcript" onclick="generateTranscript()">
                    <i class="bi bi-chat-dots"></i>
                    Generate Podcast Script
                </button>
                {% endif %}
            </div>
            {% endif %}

            {% if current_file.audio_exists %}
            <div class="workflow-step completed">
                <div class="step-header">
                    <h3><span class="step-num">4</span> Audio Ready</h3>
                    <button class="btn btn-sm btn-ghost" onclick="showTranscript()">Edit Script</button>
                </div>
                <div class="step-content">
                    <div class="audio-player">
                        <audio controls class="w-100">
                            <source src="{{ url_for('static.generated_audio', filename=current_file.audio_filename) }}" type="audio/mpeg">
                            Your browser does not support audio.
                        </audio>
                    </div>
                    <div class="audio-actions">
                        <a href="{{ url_for('static.generated_audio', filename=current_file.audio_filename) }}" download class="btn btn-outline">
                            <i class="bi bi-download"></i>
                            Download
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Task Status Section -->
            <div class="workflow-step" id="task-status-section" style="display: none;">
                <div class="step-header">
                    <h3><i class="bi bi-list-task"></i> Processing Status</h3>
                    <button class="btn btn-sm btn-ghost" onclick="refreshTaskStatus()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="step-content">
                    <div id="task-list" class="task-list">
                        <!-- Task items will be loaded here -->
                    </div>
                </div>
            </div>

            <div class="workflow-step">
                <div class="step-header">
                    <h3><i class="bi bi-chat-dots"></i> Chat with Document</h3>
                </div>
                <div class="step-content">
                    <button class="btn btn-outline w-100" onclick="openChat()">
                        <i class="bi bi-chat"></i>
                        Open Chat
                    </button>
                </div>
            </div>
        </div>

        <div id="loading-overlay" class="loading-overlay" style="display: none;">
            <div class="spinner"></div>
            <p id="loading-text">Processing...</p>
        </div>

        <div id="progress-modal" class="progress-modal hidden">
            <div class="progress-card">
                <div id="progress-icon" class="progress-icon processing">
                    <i class="bi bi-hourglass-split"></i>
                </div>
                <h3 id="progress-title" class="progress-title">Processing...</h3>
                <p id="progress-subtitle" class="progress-subtitle">Please wait</p>
                <div class="progress-steps" id="progress-steps">
                    <div class="progress-step active" data-step="1" title="Ingest"></div>
                    <div class="progress-step" data-step="2" title="Summary"></div>
                    <div class="progress-step" data-step="3" title="Script"></div>
                    <div class="progress-step" data-step="4" title="Audio"></div>
                </div>
                <div class="progress-bar-container">
                    <div id="progress-bar" class="progress-bar"></div>
                </div>
                <p id="progress-status" class="text-muted small">Step 1 of 4</p>
                <button id="progress-cancel" class="btn btn-ghost btn-sm mt-3" onclick="cancelCurrentTask()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="sidebar" class="library-sidebar">
        <h4>Library</h4>
        
        <div class="library-search">
            <form method="get" action="{{ url_for('files.index') }}" id="library-search-form">
                <div class="library-controls">
                    <select name="sort" class="form-select form-select-sm" onchange="this.form.submit()" title="Sort files">
                        <option value="newest" {% if sort_order == 'newest' or not sort_order %}selected{% endif %}>Newest First</option>
                        <option value="oldest" {% if sort_order == 'oldest' %}selected{% endif %}>Oldest First</option>
                        <option value="name_asc" {% if sort_order == 'name_asc' %}selected{% endif %}>Name (A-Z)</option>
                        <option value="name_desc" {% if sort_order == 'name_desc' %}selected{% endif %}>Name (Z-A)</option>
                        <option value="status" {% if sort_order == 'status' %}selected{% endif %}>Processing Status</option>
                    </select>
                </div>
                {% if dataset_groups or uncategorized_count > 0 %}
                <select name="dataset" class="form-select form-select-sm mb-2" onchange="this.form.submit()">
                    <option value="">All Files</option>
                    {% for dataset_name, count in dataset_groups %}
                    <option value="{{ dataset_name }}" {% if filter_dataset == dataset_name %}selected{% endif %}>{{ dataset_name }} ({{ count }})</option>
                    {% endfor %}
                    {% if uncategorized_count > 0 %}
                    <option value="_uncategorized" {% if filter_dataset == '_uncategorized' %}selected{% endif %}>Uncategorized ({{ uncategorized_count }})</option>
                    {% endif %}
                </select>
                {% endif %}
                <div class="input-group input-group-sm">
                    <input type="text" name="search" class="form-control" placeholder="Search..." value="{{ search_query or '' }}">
                    <button class="btn btn-outline" type="submit">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
                {% if all_tags %}
                <select name="tag" class="form-select form-select-sm mt-2" onchange="this.form.submit()">
                    <option value="">All Tags</option>
                    {% for tag in all_tags %}
                    <option value="{{ tag }}" {% if filter_tag == tag %}selected{% endif %}>{{ tag }}</option>
                    {% endfor %}
                </select>
                {% endif %}
                {% if search_query or filter_tag or filter_dataset %}
                <a href="{{ url_for('files.index') }}" class="btn btn-sm btn-link mt-1">Clear filters</a>
                {% endif %}
            </form>
        </div>
        
        <div class="library-list">
            {% for file in all_files %}
            <div class="library-item-row" title="{{ file.filename }}">
                <a href="/?file={{ file.id }}" class="library-item {% if file.id == current_file.id %}active{% endif %}">
                    <i class="bi bi-file-earmark-text"></i>
                    <div class="library-item-info">
                        <span class="library-item-name">{{ file.filename[:20] }}{% if file.filename|length > 20 %}...{% endif %}</span>
                        <span class="library-item-meta">
                            {% if file.created_at %}
                            <i class="bi bi-calendar3"></i> {{ file.created_at.strftime('%b %d') }}
                            {% endif %}
                        </span>
                        {% if file.tags_list %}
                        <div class="library-item-tags">
                            {% for tag in file.tags_list[:2] %}
                            <span class="tag-badge">{{ tag[:8] }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    <div class="library-item-status">
                        {% if file.audio_exists %}
                        <i class="bi bi-check-circle-fill text-success" title="Audio ready"></i>
                        {% elif file.summary %}
                        <i class="bi bi-play-circle text-warning" title="Audio not generated"></i>
                        {% elif file.text %}
                        <i class="bi bi-hourglass text-muted" title="Processing"></i>
                        {% else %}
                        <i class="bi bi-circle text-muted" title="Not processed"></i>
                        {% endif %}
                    </div>
                </a>
                <button class="btn btn-ghost btn-sm library-delete" onclick="event.preventDefault(); deleteFile({{ file.id }})" title="Delete" aria-label="Delete {{ file.filename }}">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            {% endfor %}
        </div>
        <a href="{{ url_for('ragflow.ragflow_browser') }}" class="btn btn-outline w-100 mt-3">
            <i class="bi bi-cloud-download"></i>
            Import from Ragflow
        </a>
        <button class="btn btn-outline w-100 mt-2" onclick="window.location.href='/'">
            <i class="bi bi-plus-lg"></i>
            New Upload
        </button>
    </div>
    </div>
</div>
{% endif %}

<!-- Modals -->
<div class="modal-overlay" id="summary-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Summary</h3>
            <button class="btn btn-ghost" onclick="closeModal('summary-modal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="summary-text">{{ current_file.summary if current_file.summary else 'No summary yet.' }}</div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="original-text-modal" style="display: none;">
    <div class="modal-content modal-lg" style="max-width: 900px;">
        <div class="modal-header">
            <h3>Original Text</h3>
            <button class="btn btn-ghost" onclick="closeModal('original-text-modal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body" style="white-space: pre-wrap; font-size: 13px; line-height: 1.6;">
            <div id="original-text-content">Loading...</div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="transcript-modal" style="display: none;">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3>Podcast Script</h3>
            <button class="btn btn-ghost" onclick="closeModal('transcript-modal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body">
            <textarea class="form-control" id="transcript-edit" rows="15">{{ current_file.transcript if current_file.transcript else '' }}</textarea>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="saveAndGenerate()">
                <i class="bi bi-play-circle"></i>
                Save & Generate Audio
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="chat-modal" style="display: none;">
    <div class="modal-content modal-lg" style="max-width: 700px; height: 80vh;">
        <div class="modal-header">
            <h3><i class="bi bi-chat-dots"></i> Chat with Document</h3>
            <button class="btn btn-ghost" onclick="closeModal('chat-modal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body" style="display: flex; flex-direction: column; padding: 0;">
            <div class="chat-options" style="padding: 12px 20px; border-bottom: 1px solid var(--border);">
                <label class="chat-toggle">
                    <input type="checkbox" id="ragflow-toggle">
                    <span>Include Ragflow context</span>
                </label>
                <select id="ragflow-dataset" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                    <option value="">Loading datasets...</option>
                </select>
            </div>
            <div id="chat-messages" class="chat-messages" style="flex: 1; overflow-y: auto; padding: 20px;">
                <div class="chat-message assistant">
                    <p>Ask me anything about this document. I can also pull relevant context from your Ragflow knowledge base if enabled.</p>
                </div>
            </div>
            <div class="chat-input-container" style="padding: 16px 20px; border-top: 1px solid var(--border);">
                <div class="input-group">
                    <input type="text" id="chat-input" class="form-control" placeholder="Ask a question about this document..." onkeypress="if(event.key==='Enter')sendChat()">
                    <button class="btn btn-primary" onclick="sendChat()">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
window.CURRENT_FILE_ID = {{ current_file.id if current_file else 'null' }};
document.body.dataset.hasSummary = {{ 'true' if current_file and current_file.summary else 'false' }};
window.ragflowDatasetsUrl = "{{ url_for('ragflow.ragflow_datasets') }}";

document.addEventListener('DOMContentLoaded', function() {
    // Render markdown content
    document.querySelectorAll('[data-markdown]').forEach(function(el) {
        if (typeof marked !== 'undefined') {
            el.innerHTML = marked.parse(el.textContent);
        }
    });
});
</script>
{% endblock %}
