<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioPaper</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo">
                    <i class="bi bi-file-earmark-text"></i>
                    <span>AudioPaper</span>
                </div>
                <div class="header-actions">
                    <a href="{{ url_for('ragflow_browser') }}" class="btn btn-ghost" title="Ragflow Browser">
                        <i class="bi bi-collection-fill"></i>
                    </a>
                    <a href="{{ url_for('settings') }}" class="btn btn-ghost" title="Settings">
                        <i class="bi bi-gear"></i>
                    </a>
                </div>
            </div>
        </header>

        <main class="main-content">
            {% if not current_file %}
            <!-- Empty State / Upload - Show with library sidebar -->
            <div class="workflow-container">
                <div class="upload-section">
                    <div class="upload-card">
                        <div class="upload-icon">
                            <i class="bi bi-file-earmark-pdf"></i>
                        </div>
                        <h2>Upload a Research Paper</h2>
                        <p>Drop your PDF here or click to browse</p>
                        <form action="/upload" method="post" enctype="multipart/form-data" id="upload-form">
                            <input type="file" name="file" id="file-input" accept="application/pdf" hidden>
                            <button type="button" class="btn btn-primary btn-lg" onclick="document.getElementById('file-input').click()">
                                <i class="bi bi-upload"></i>
                                Choose PDF
                            </button>
                            
                            <div class="upload-options mt-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="upload_to_ragflow" name="upload_to_ragflow">
                                    <label class="form-check-label" for="upload_to_ragflow">
                                        Also upload to Ragflow
                                    </label>
                                </div>
                                <select class="form-select form-select-sm mt-2" name="ragflow_dataset" id="ragflow-dataset-select" style="display: none;">
                                    <option value="">Loading datasets...</option>
                                </select>
                            </div>
                        </form>
                        <p class="upload-hint">Supported: PDF files</p>
                    </div>
                </div>
                
                <!-- Library Sidebar (always visible) -->
                <div class="library-sidebar">
                    <h4>Library</h4>
                    {% if all_files %}
                    <div class="library-list">
                        {% for file in all_files %}
                        <a href="/?file={{ file.id }}" class="library-item">
                            <i class="bi bi-file-earmark-text"></i>
                            <span>{{ file.filename[:25] }}{% if file.filename|length > 25 %}...{% endif %}</span>
                            {% if file.summary %}<i class="bi bi-check-circle-fill text-success ms-auto"></i>{% endif %}
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted small">No papers yet</p>
                    {% endif %}
                    <a href="{{ url_for('ragflow_browser') }}" class="btn btn-outline w-100 mt-3">
                        <i class="bi bi-cloud-download"></i>
                        Import from Ragflow
                    </a>
                </div>
            </div>
            {% else %}
            <!-- Workflow View -->
            <div class="workflow-container">
                <!-- File Info Bar -->
                <div class="file-info-bar">
                    <div class="file-details">
                        <i class="bi bi-file-earmark-pdf"></i>
                        <span class="filename">{{ current_file.filename }}</span>
                    </div>
                    <div class="file-actions">
                        <button class="btn btn-ghost btn-sm" onclick="showOriginalText()" title="View Original Text">
                            <i class="bi bi-file-text"></i>
                        </button>
                        <button class="btn btn-ghost btn-sm text-danger" onclick="deleteFile({{ current_file.id }})" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                        <button class="btn btn-ghost btn-sm" onclick="window.location.href='/'">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>

                <!-- Step Indicator -->
                <div class="steps-indicator">
                    <div class="step {% if current_file.text %}completed{% elif current_file %}active{% endif %}">
                        <div class="step-number">1</div>
                        <div class="step-label">Ingest</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step {% if current_file.summary %}completed{% elif current_file and initial_task_id %}active{% endif %}">
                        <div class="step-number">2</div>
                        <div class="step-label">Summary</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step {% if current_file.transcript %}completed{% endif %}">
                        <div class="step-number">3</div>
                        <div class="step-label">Script</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step {% if audio_exists %}completed{% endif %}">
                        <div class="step-number">4</div>
                        <div class="step-label">Audio</div>
                    </div>
                </div>

                <!-- Main Workflow Area -->
                <div class="workflow-content">
                    <!-- Auto-summary loading state (no file selected yet) -->
                    {% if initial_task_id and not current_file.summary %}
                    <div class="workflow-step">
                        <div class="step-header">
                            <h3><span class="step-num">2</span> Generating Summary</h3>
                        </div>
                        <div class="step-content">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2">Analyzing paper and creating summary...</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- No file selected - show library with options -->
                    {% if not current_file %}
                    <div class="workflow-step">
                        <div class="step-header">
                            <h3>Your Library</h3>
                        </div>
                        <div class="step-content">
                            {% if all_files %}
                            <p class="text-muted">Select a paper from the sidebar or upload a new one.</p>
                            {% else %}
                            <p class="text-muted">No papers yet. Upload a PDF or import from Ragflow.</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- File selected but no summary yet -->
                    {% if current_file and not current_file.summary and not initial_task_id %}
                    <div class="workflow-step">
                        <div class="step-header">
                            <h3><span class="step-num">2</span> Summary</h3>
                        </div>
                        <div class="step-content">
                            <p class="text-muted">Summary not generated yet.</p>
                            <button class="btn btn-primary btn-lg w-100" onclick="generateSummary()">
                                <i class="bi bi-lightning"></i>
                                Generate Summary
                            </button>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Step 2: Summary -->
                    {% if current_file.summary %}
                    <div class="workflow-step">
                        <div class="step-header">
                            <h3><span class="step-num">2</span> Summary</h3>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-ghost" onclick="showSummary()">View</button>
                                <button class="btn btn-sm btn-ghost" onclick="regenerateSummary()" title="Regenerate">
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>
                            </div>
                        </div>
                        <div class="step-content">
                            <div class="summary-preview">
                                {{ current_file.summary[:500] }}...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 3: Generate Podcast (after summary) -->
                    <div class="workflow-step">
                        <div class="step-header">
                            <h3><span class="step-num">3</span> Podcast Script</h3>
                            {% if current_file.transcript %}
                            <div class="btn-group">
                                <button class="btn btn-sm btn-ghost" onclick="showTranscript()">Edit</button>
                                <button class="btn btn-sm btn-ghost" onclick="regenerateTranscript()" title="Regenerate">
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                            {% if current_file.transcript %}
                            <div class="transcript-preview">
                                {{ current_file.transcript[:300] }}...
                            </div>
                            {% if audio_exists %}
                            <div class="mt-3 text-success">
                                <i class="bi bi-check-circle"></i> Audio ready!
                            </div>
                            {% else %}
                            <button class="btn btn-primary btn-lg w-100 mt-3" onclick="generatePodcast()">
                                <i class="bi bi-play-circle"></i>
                                Generate Audio
                            </button>
                            {% endif %}
                            {% else %}
                            <button class="btn btn-primary btn-lg w-100 mt-3" onclick="generateTranscript()">
                                <i class="bi bi-chat-dots"></i>
                                Generate Podcast Script
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Step 4: Audio Ready -->
                    {% if audio_exists %}
                    <div class="workflow-step completed">
                        <div class="step-header">
                            <h3><span class="step-num">4</span> Audio Ready</h3>
                            <button class="btn btn-sm btn-ghost" onclick="showTranscript()">Edit Script</button>
                        </div>
                        <div class="step-content">
                            <div class="audio-player">
                                <audio controls class="w-100">
                                    <source src="{{ url_for('generated_audio', filename='dialogue_' + current_file.id|string + '.mp3') }}" type="audio/mpeg">
                                    Your browser does not support audio.
                                </audio>
                            </div>
                            <div class="audio-actions">
                                <a href="{{ url_for('generated_audio', filename='dialogue_' + current_file.id|string + '.mp3') }}" download class="btn btn-outline">
                                    <i class="bi bi-download"></i>
                                    Download
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Chat Section -->
                    <div class="workflow-step">
                        <div class="step-header">
                            <h3><i class="bi bi-chat-dots"></i> Chat with Document</h3>
                        </div>
                        <div class="step-content">
                            <button class="btn btn-outline w-100" onclick="openChat()">
                                <i class="bi bi-chat"></i>
                                Open Chat
                            </button>
                        </div>
                    </div>

                    <!-- Loading States -->
                    <div id="loading-overlay" class="loading-overlay" style="display: none;">
                        <div class="spinner"></div>
                        <p id="loading-text">Processing...</p>
                    </div>
                </div>

                <!-- Sidebar: File Library -->
                <div class="library-sidebar">
                    <h4>Library</h4>
                    <div class="library-list">
                        {% for file in all_files %}
                        <div class="library-item-row">
                            <a href="/?file={{ file.id }}" class="library-item {% if file.id == current_file.id %}active{% endif %}">
                                <i class="bi bi-file-earmark-text"></i>
                                <span>{{ file.filename[:18] }}{% if file.filename|length > 18 %}...{% endif %}</span>
                                {% if file.summary %}<i class="bi bi-check-circle-fill text-success ms-auto" title="Summary ready"></i>{% endif %}
                            </a>
                            <button class="btn btn-ghost btn-sm library-delete" onclick="event.preventDefault(); deleteFile({{ file.id }})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    <a href="{{ url_for('ragflow_browser') }}" class="btn btn-outline w-100 mt-3">
                        <i class="bi bi-cloud-download"></i>
                        Import from Ragflow
                    </a>
                    <button class="btn btn-outline w-100 mt-2" onclick="window.location.href='/'">
                        <i class="bi bi-plus-lg"></i>
                        New Upload
                    </button>
                </div>
            </div>
            {% endif %}
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="summary-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Summary</h3>
                <button class="btn btn-ghost" onclick="closeModal('summary-modal')">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="summary-text">{{ current_file.summary if current_file.summary else 'No summary yet.' }}</div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="original-text-modal" style="display: none;">
        <div class="modal-content modal-lg" style="max-width: 900px;">
            <div class="modal-header">
                <h3>Original Text</h3>
                <button class="btn btn-ghost" onclick="closeModal('original-text-modal')">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body" style="white-space: pre-wrap; font-size: 13px; line-height: 1.6;">
                <div id="original-text-content">{{ current_file.text }}</div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="transcript-modal" style="display: none;">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3>Podcast Script</h3>
                <button class="btn btn-ghost" onclick="closeModal('transcript-modal')">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="transcript-edit" rows="15">{{ current_file.transcript if current_file.transcript else '' }}</textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveAndGenerate()">
                    <i class="bi bi-play-circle"></i>
                    Save & Generate Audio
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div class="modal-overlay" id="chat-modal" style="display: none;">
        <div class="modal-content modal-lg" style="max-width: 700px; height: 80vh;">
            <div class="modal-header">
                <h3><i class="bi bi-chat-dots"></i> Chat with Document</h3>
                <button class="btn btn-ghost" onclick="closeModal('chat-modal')">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; padding: 0;">
                <div class="chat-options" style="padding: 12px 20px; border-bottom: 1px solid var(--border);">
                    <label class="chat-toggle">
                        <input type="checkbox" id="ragflow-toggle">
                        <span>Include Ragflow context</span>
                    </label>
                    <select id="ragflow-dataset" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                        <option value="">Loading datasets...</option>
                    </select>
                </div>
                <div id="chat-messages" class="chat-messages" style="flex: 1; overflow-y: auto; padding: 20px;">
                    <div class="chat-message assistant">
                        <p>Ask me anything about this document. I can also pull relevant context from your Ragflow knowledge base if enabled.</p>
                    </div>
                </div>
                <div class="chat-input-container" style="padding: 16px 20px; border-top: 1px solid var(--border);">
                    <div class="input-group">
                        <input type="text" id="chat-input" class="form-control" placeholder="Ask a question about this document..." onkeypress="if(event.key==='Enter')sendChat()">
                        <button class="btn btn-primary" onclick="sendChat()">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // Load Ragflow datasets for upload dropdown
        fetch('/ragflow/datasets')
            .then(r => r.json())
            .then(data => {
                const select = document.getElementById('ragflow-dataset-select');
                if (data.datasets) {
                    select.innerHTML = data.datasets.map(d => 
                        `<option value="${d.id}">${d.name}</option>`
                    ).join('');
                }
            });
        
        // Toggle ragflow dataset dropdown
        document.getElementById('upload_to_ragflow')?.addEventListener('change', function() {
            const select = document.getElementById('ragflow-dataset-select');
            select.style.display = this.checked ? 'block' : 'none';
        });

        // File input handler
        document.getElementById('file-input')?.addEventListener('change', function() {
            if (this.files.length > 0) {
                document.getElementById('upload-form').submit();
            }
        });

        // Poll for initial summary task if present
        const initialTaskId = '{{ initial_task_id }}';
        if (initialTaskId && initialTaskId !== 'None') {
            pollTask(initialTaskId, 'summary');
        }

        // Workflow functions
        function generateSummary() {
            showLoading('Generating summary...');
            fetch('/summarize_file/{{ current_file.id }}', { method: 'POST' })
                .then(r => r.json())
                .then(data => pollTask(data.task_id, 'summary'));
        }

        function generatePodcast() {
            showLoading('Generating podcast audio...');
            fetch('/generate_podcast/{{ current_file.id }}', { method: 'POST' })
                .then(r => r.json())
                .then(data => pollTask(data.task_id, 'podcast'));
        }

        function generateTranscript() {
            showLoading('Creating podcast script...');
            fetch('/generate_transcript/{{ current_file.id }}', { method: 'POST' })
                .then(r => r.json())
                .then(data => pollTask(data.task_id, 'transcript'));
        }

        function regenerateSummary() {
            if (!confirm('Regenerate summary?')) return;
            showLoading('Regenerating summary...');
            fetch('/summarize_file/{{ current_file.id }}', { method: 'POST' })
                .then(r => r.json())
                .then(data => pollTask(data.task_id, 'summary'));
        }

        function regenerateTranscript() {
            if (!confirm('Regenerate podcast script?')) return;
            showLoading('Regenerating script...');
            fetch('/generate_transcript/{{ current_file.id }}', { method: 'POST' })
                .then(r => r.json())
                .then(data => pollTask(data.task_id, 'transcript'));
        }

        function deleteFile(fileId) {
            if (!confirm('Delete this paper? This will remove the summary, transcript, and any generated audio.')) return;
            
            fetch(`/delete_file/${fileId}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                    } else {
                        window.location.href = '/';
                    }
                })
                .catch(err => alert('Error: ' + err));
        }

        function showSummary() {
            // Render markdown
            const el = document.getElementById('summary-text');
            if (el && typeof marked !== 'undefined') {
                el.innerHTML = marked.parse(el.textContent || el.innerText);
            }
            document.getElementById('summary-modal').style.display = 'flex';
        }

        function showOriginalText() {
            document.getElementById('original-text-modal').style.display = 'flex';
        }

        function showTranscript() {
            document.getElementById('transcript-modal').style.display = 'flex';
        }

        function saveAndGenerate() {
            const transcript = document.getElementById('transcript-edit').value;
            
            // Save the transcript first
            fetch('/save_transcript/{{ current_file.id }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ transcript: transcript })
            })
            .then(r => r.json())
            .then(data => {
                closeModal('transcript-modal');
                generatePodcast();
            })
            .catch(err => {
                alert('Error saving transcript: ' + err);
            });
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function showLoading(text) {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function pollTask(taskId, type) {
            // Fix: route is summarize_status not summary_status
            const statusType = (type === 'summary') ? 'summarize' : type;
            const interval = setInterval(() => {
                fetch('/' + statusType + '_status/' + taskId)
                    .then(r => r.json())
                    .then(data => {
                        if (data.status === 'complete') {
                            clearInterval(interval);
                            hideLoading();
                            window.location.reload();
                        } else if (data.status === 'error') {
                            clearInterval(interval);
                            hideLoading();
                            alert('Error: ' + (data.result?.error || 'Unknown error'));
                        }
                    });
            }, 2000);
        }

        // Chat functions
        let chatFileId = {{ current_file.id if current_file else 'null' }};
        
        function openChat() {
            document.getElementById('chat-modal').style.display = 'flex';
            loadRagflowDatasets();
        }

        function loadRagflowDatasets() {
            fetch('/ragflow/datasets')
                .then(r => r.json())
                .then(data => {
                    const select = document.getElementById('ragflow-dataset');
                    if (data.error) {
                        select.innerHTML = '<option value="">Ragflow not configured</option>';
                        return;
                    }
                    select.innerHTML = '<option value="">Select dataset...</option>' +
                        data.datasets.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
                })
                .catch(() => {
                    document.getElementById('ragflow-dataset').innerHTML = '<option value="">Ragflow error</option>';
                });
        }

        function sendChat() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            const useRagflow = document.getElementById('ragflow-toggle').checked;
            const datasetId = document.getElementById('ragflow-dataset').value;

            // Add user message to chat
            addMessage('user', message);
            input.value = '';

            // Show typing indicator
            const messagesDiv = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message assistant typing';
            typingDiv.innerHTML = '<p><i class="bi bi-three-dots"></i> Thinking...</p>';
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            fetch(`/chat_file/${chatFileId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    message: message,
                    use_ragflow: useRagflow,
                    ragflow_dataset_id: datasetId || null
                })
            })
            .then(r => r.json())
            .then(data => {
                typingDiv.remove();
                if (data.error) {
                    addMessage('assistant', 'Error: ' + data.error);
                } else {
                    if (data.ragflow_used) {
                        addMessage('assistant', data.message + '\n\n<small><i class="bi bi-info-circle"></i> Used Ragflow context</small>');
                    } else {
                        addMessage('assistant', data.message);
                    }
                }
            })
            .catch(err => {
                typingDiv.remove();
                addMessage('assistant', 'Error: ' + err);
            });
        }

        function addMessage(role, content) {
            const messagesDiv = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `chat-message ${role}`;
            div.innerHTML = `<p>${content.replace(/\n/g, '<br>')}</p>`;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
</body>
</html>
