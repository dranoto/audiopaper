<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioPaper</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo">
                    <i class="bi bi-file-earmark-text"></i>
                    <span>AudioPaper</span>
                </div>
                <div class="header-actions">
                    <a href="{{ url_for('ragflow_browser') }}" class="btn btn-ghost" title="Ragflow Browser">
                        <i class="bi bi-collection-fill"></i>
                    </a>
                    <a href="{{ url_for('settings') }}" class="btn btn-ghost" title="Settings">
                        <i class="bi bi-gear"></i>
                    </a>
                </div>
            </div>
        </header>

        <main class="main-content">
            {% if not current_file %}
            <!-- Empty State / Upload -->
            <div class="upload-section">
                <div class="upload-card">
                    <div class="upload-icon">
                        <i class="bi bi-file-earmark-pdf"></i>
                    </div>
                    <h2>Upload a Research Paper</h2>
                    <p>Drop your PDF here or click to browse</p>
                    <form action="/upload" method="post" enctype="multipart/form-data" id="upload-form">
                        <input type="file" name="file" id="file-input" accept="application/pdf" hidden>
                        <button type="button" class="btn btn-primary btn-lg" onclick="document.getElementById('file-input').click()">
                            <i class="bi bi-upload"></i>
                            Choose PDF
                        </button>
                    </form>
                    <p class="upload-hint">Supported: PDF files</p>
                </div>
            </div>
            {% else %}
            <!-- Workflow View -->
            <div class="workflow-container">
                <!-- File Info Bar -->
                <div class="file-info-bar">
                    <div class="file-details">
                        <i class="bi bi-file-earmark-pdf"></i>
                        <span class="filename">{{ current_file.filename }}</span>
                    </div>
                    <div class="file-actions">
                        <button class="btn btn-ghost btn-sm" onclick="window.location.href='/'">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>

                <!-- Step Indicator -->
                <div class="steps-indicator">
                    <div class="step {% if current_file.text %}completed{% elif current_file %}active{% endif %}">
                        <div class="step-number">1</div>
                        <div class="step-label">Ingest</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step {% if current_file.summary %}completed{% endif %}">
                        <div class="step-number">2</div>
                        <div class="step-label">Summarize</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step {% if current_file.transcript %}completed{% endif %}">
                        <div class="step-number">3</div>
                        <div class="step-label">Script</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step {% if audio_exists %}completed{% endif %}">
                        <div class="step-number">4</div>
                        <div class="step-label">Generate</div>
                    </div>
                </div>

                <!-- Main Workflow Area -->
                <div class="workflow-content">
                    <!-- Step 1: Ingest (Show extracted text) -->
                    {% if current_file.text and not current_file.summary %}
                    <div class="workflow-step">
                        <div class="step-header">
                            <h3><span class="step-num">1</span> Document Ingested</h3>
                            <p class="step-desc">Your PDF has been processed. Ready to summarize.</p>
                        </div>
                        <div class="step-content">
                            <button class="btn btn-primary btn-lg w-100" onclick="generateSummary()">
                                <i class="bi bi-lightning"></i>
                                Generate Summary
                            </button>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Step 2: Summary -->
                    {% if current_file.summary and not current_file.transcript %}
                    <div class="workflow-step">
                        <div class="step-header">
                            <h3><span class="step-num">2</span> Summary</h3>
                            <button class="btn btn-sm btn-ghost" onclick="showSummary()">View</button>
                        </div>
                        <div class="step-content">
                            <div class="summary-preview">
                                {{ current_file.summary[:500] }}...
                            </div>
                            <button class="btn btn-primary btn-lg w-100 mt-3" onclick="generateTranscript()">
                                <i class="bi bi-chat-dots"></i>
                                Generate Podcast Script
                            </button>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Step 3: Script -->
                    {% if current_file.transcript and not audio_exists %}
                    <div class="workflow-step">
                        <div class="step-header">
                            <h3><span class="step-num">3</span> Podcast Script</h3>
                            <button class="btn btn-sm btn-ghost" onclick="showTranscript()">View/Edit</button>
                        </div>
                        <div class="step-content">
                            <div class="transcript-preview">
                                {{ current_file.transcript[:300] }}...
                            </div>
                            <button class="btn btn-primary btn-lg w-100 mt-3" onclick="generatePodcast()">
                                <i class="bi bi-play-circle"></i>
                                Generate Audio
                            </button>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Step 4: Audio Ready -->
                    {% if audio_exists %}
                    <div class="workflow-step completed">
                        <div class="step-header">
                            <h3><span class="step-num">4</span> Audio Ready</h3>
                        </div>
                        <div class="step-content">
                            <div class="audio-player">
                                <audio controls class="w-100">
                                    <source src="{{ url_for('generated_audio', filename='dialogue_' + current_file.id|string + '.mp3') }}" type="audio/mpeg">
                                    Your browser does not support audio.
                                </audio>
                            </div>
                            <div class="audio-actions">
                                <a href="{{ url_for('generated_audio', filename='dialogue_' + current_file.id|string + '.mp3') }}" download class="btn btn-outline">
                                    <i class="bi bi-download"></i>
                                    Download
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Loading States -->
                    <div id="loading-overlay" class="loading-overlay" style="display: none;">
                        <div class="spinner"></div>
                        <p id="loading-text">Processing...</p>
                    </div>
                </div>

                <!-- Sidebar: File Library -->
                <div class="library-sidebar">
                    <h4>Library</h4>
                    <div class="library-list">
                        {% for file in all_files %}
                        <a href="/?file={{ file.id }}" class="library-item {% if file.id == current_file.id %}active{% endif %}">
                            <i class="bi bi-file-earmark-pdf"></i>
                            <span>{{ file.filename[:25] }}{% if file.filename|length > 25 %}...{% endif %}</span>
                        </a>
                        {% endfor %}
                    </div>
                    <button class="btn btn-outline w-100 mt-3" onclick="window.location.href='/'">
                        <i class="bi bi-plus-lg"></i>
                        New Upload
                    </button>
                </div>
            </div>
            {% endif %}
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="summary-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Summary</h3>
                <button class="btn btn-ghost" onclick="closeModal('summary-modal')">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="summary-text">{{ current_file.summary if current_file.summary else 'No summary yet.' }}</p>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="transcript-modal" style="display: none;">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3>Podcast Script</h3>
                <button class="btn btn-ghost" onclick="closeModal('transcript-modal')">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="transcript-edit" rows="15">{{ current_file.transcript if current_file.transcript else '' }}</textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveAndGenerate()">
                    <i class="bi bi-play-circle"></i>
                    Save & Generate Audio
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // File input handler
        document.getElementById('file-input')?.addEventListener('change', function() {
            if (this.files.length > 0) {
                document.getElementById('upload-form').submit();
            }
        });

        // Workflow functions
        function generateSummary() {
            showLoading('Generating summary...');
            fetch('/summarize_file/{{ current_file.id }}', { method: 'POST' })
                .then(r => r.json())
                .then(data => pollTask(data.task_id, 'summary'));
        }

        function generateTranscript() {
            showLoading('Creating podcast script...');
            fetch('/generate_transcript/{{ current_file.id }}', { method: 'POST' })
                .then(r => r.json())
                .then(data => pollTask(data.task_id, 'transcript'));
        }

        function generatePodcast() {
            showLoading('Generating audio...');
            fetch('/generate_podcast/{{ current_file.id }}', { method: 'POST' })
                .then(r => r.json())
                .then(data => pollTask(data.task_id, 'podcast'));
        }

        function showSummary() {
            document.getElementById('summary-modal').style.display = 'flex';
        }

        function showTranscript() {
            document.getElementById('transcript-modal').style.display = 'flex';
        }

        function saveAndGenerate() {
            const transcript = document.getElementById('transcript-edit').value;
            // TODO: Save transcript edits if needed
            closeModal('transcript-modal');
            generatePodcast();
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function showLoading(text) {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function pollTask(taskId, type) {
            const interval = setInterval(() => {
                fetch(`/{{ type }}_status/${taskId}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.status === 'complete') {
                            clearInterval(interval);
                            hideLoading();
                            window.location.reload();
                        } else if (data.status === 'error') {
                            clearInterval(interval);
                            hideLoading();
                            alert('Error: ' + (data.result?.error || 'Unknown error'));
                        }
                    });
            }, 2000);
        }
    </script>
</body>
</html>
