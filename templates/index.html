{% extends "base.html" %}

{% block title %}AudioPaper{% endblock %}

{% block header_actions %}
<div class="header-actions">
    <button class="btn btn-ghost" id="sidebar-toggle" title="Toggle Sidebar">
        <i class="bi bi-layout-sidebar"></i>
    </button>
    <a href="{{ url_for('ragflow.ragflow_browser') }}" class="btn btn-ghost" title="Ragflow Browser">
        <i class="bi bi-collection-fill"></i>
    </a>
    <a href="{{ url_for('settings.settings') }}" class="btn btn-ghost" title="Settings">
        <i class="bi bi-gear"></i>
    </a>
</div>
{% endblock %}

{% block content %}
{% if not current_file %}
<div class="workflow-container">
    <div id="main-content">
        <div class="upload-section">
        <div class="upload-card">
            <div class="upload-icon">
                <i class="bi bi-file-earmark-pdf"></i>
            </div>
            <h2>Upload a Research Paper</h2>
            <p>Drop your PDF here or click to browse</p>
            <form action="{{ url_for('files.upload_file') }}" method="post" enctype="multipart/form-data" id="upload-form">
                <input type="file" name="file" id="file-input" accept="application/pdf" hidden>
                <button type="button" class="btn btn-primary btn-lg" onclick="document.getElementById('file-input').click()">
                    <i class="bi bi-upload"></i>
                    Choose PDF
                </button>
                
                <div class="upload-options mt-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="upload_to_ragflow" name="upload_to_ragflow">
                        <label class="form-check-label" for="upload_to_ragflow">
                            Also upload to Ragflow
                        </label>
                    </div>
                    <select class="form-select form-select-sm mt-2" name="ragflow_dataset" id="ragflow-dataset-select" style="display: none;">
                        <option value="">Loading datasets...</option>
                    </select>
                </div>
            </form>
            <p class="upload-hint">Supported: PDF files</p>
        </div>
    </div>
    
    <div id="sidebar" class="library-sidebar">
        <h4>Library</h4>
        {% if all_files %}
        <div class="library-list">
            {% for file in all_files %}
            <a href="/?file={{ file.id }}" class="library-item">
                <i class="bi bi-file-earmark-text"></i>
                <span>{{ file.filename[:25] }}{% if file.filename|length > 25 %}...{% endif %}</span>
                {% if file.summary %}<i class="bi bi-check-circle-fill text-success ms-auto"></i>{% endif %}
            </a>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted small">No papers yet</p>
        {% endif %}
        <a href="{{ url_for('ragflow.ragflow_browser') }}" class="btn btn-outline w-100 mt-3">
            <i class="bi bi-cloud-download"></i>
            Import from Ragflow
        </a>
    </div>
</div>
{% else %}
<div class="workflow-container">
    <div id="main-content">
    <div class="file-info-bar">
        <div class="file-details">
            <i class="bi bi-file-earmark-pdf"></i>
            <span class="filename">{{ current_file.filename }}</span>
        </div>
        <div class="file-actions">
            <button class="btn btn-ghost btn-sm" onclick="showOriginalText()" title="View Original Text">
                <i class="bi bi-file-text"></i>
            </button>
            <button class="btn btn-ghost btn-sm text-danger" onclick="deleteFile({{ current_file.id }})" title="Delete">
                <i class="bi bi-trash"></i>
            </button>
            <button class="btn btn-ghost btn-sm" onclick="window.location.href='/'">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </div>

    <div class="steps-indicator">
        <div class="step {% if current_file.text %}completed{% elif current_file %}active{% endif %}">
            <div class="step-number">1</div>
            <div class="step-label">Ingest</div>
        </div>
        <div class="step-line"></div>
        <div class="step {% if current_file.summary %}completed{% elif current_file and auto_generate %}active{% endif %}">
            <div class="step-number">2</div>
            <div class="step-label">Summary</div>
        </div>
        <div class="step-line"></div>
        <div class="step {% if current_file.transcript %}completed{% endif %}">
            <div class="step-number">3</div>
            <div class="step-label">Script</div>
        </div>
        <div class="step-line"></div>
        <div class="step {% if current_file.audio_exists %}completed{% endif %}">
            <div class="step-number">4</div>
            <div class="step-label">Audio</div>
        </div>
    </div>

    <div class="workflow-content">
        {% if current_file %}
        <div class="workflow-step" id="inline-progress" style="display: none;">
            <div class="step-header">
                <h3><span class="step-num" id="progress-step-num">2</span> <span id="progress-title-text">Generating Summary</span></h3>
            </div>
            <div class="step-content">
                <div class="inline-progress-container active" id="inline-progress-container">
                    <div class="spinner"></div>
                    <p class="progress-status" id="progress-status-text">Analyzing paper and creating summary...</p>
                    <div class="progress-bar-container" style="max-width: 400px; margin: 0 auto;">
                        <div id="inline-progress-bar" class="progress-bar" style="width: 10%;"></div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div id="workflow-steps-container">
            {% if not current_file %}
            <div class="workflow-step">
                <div class="step-header">
                    <h3>Your Library</h3>
                </div>
                <div class="step-content">
                    {% if all_files %}
                    <p class="text-muted">Select a paper from the sidebar or upload a new one.</p>
                    {% else %}
                    <p class="text-muted">No papers yet. Upload a PDF or import from Ragflow.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if current_file and not current_file.summary and not auto_generate %}
            <div class="workflow-step">
                <div class="step-header">
                    <h3><span class="step-num">2</span> Summary</h3>
                </div>
                <div class="step-content">
                    <p class="text-muted">Summary not generated yet.</p>
                    <button class="btn btn-primary btn-lg w-100" id="btn-generate-summary" onclick="generateSummary()">
                        <i class="bi bi-lightning"></i>
                        Generate Summary
                    </button>
                </div>
            </div>
            {% endif %}

            {% if current_file.summary %}
            <div class="workflow-step">
                <div class="step-header">
                    <h3><span class="step-num">2</span> Summary</h3>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-ghost" onclick="regenerateSummary()" title="Regenerate">
                            <i class="bi bi-arrow-repeat"></i>
                        </button>
                    </div>
                </div>
                <div class="step-content">
                    <div class="content-display summary-display">
                        {{ current_file.summary }}
                    </div>
                </div>
            </div>
            
            <div class="workflow-step">
                <div class="step-header">
                    <h3><span class="step-num">3</span> Podcast Script</h3>
                    {% if current_file.transcript %}
                    <div class="btn-group">
                        <button class="btn btn-sm btn-ghost" onclick="showTranscript()">Edit</button>
                        <button class="btn btn-sm btn-ghost" onclick="regenerateTranscript()" title="Regenerate">
                            <i class="bi bi-arrow-repeat"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% if current_file.transcript %}
                <div class="content-display transcript-display">
                    {{ current_file.transcript }}
                </div>
                {% if current_file.audio_exists %}
                <div class="mt-3 text-success">
                    <i class="bi bi-check-circle"></i> Audio ready!
                </div>
                {% else %}
                <button class="btn btn-cta mt-3" id="btn-generate-audio" onclick="generatePodcast()">
                    <i class="bi bi-play-circle"></i>
                    Generate Audio
                </button>
                {% endif %}
                {% else %}
                <button class="btn btn-primary btn-lg w-100 mt-3" id="btn-generate-transcript" onclick="generateTranscript()">
                    <i class="bi bi-chat-dots"></i>
                    Generate Podcast Script
                </button>
                {% endif %}
            </div>
            {% endif %}

            {% if current_file.audio_exists %}
            <div class="workflow-step completed">
                <div class="step-header">
                    <h3><span class="step-num">4</span> Audio Ready</h3>
                    <button class="btn btn-sm btn-ghost" onclick="showTranscript()">Edit Script</button>
                </div>
                <div class="step-content">
                    <div class="audio-player">
                        <audio controls class="w-100">
                            <source src="{{ url_for('static.generated_audio', filename=current_file.audio_filename) }}" type="audio/mpeg">
                            Your browser does not support audio.
                        </audio>
                    </div>
                    <div class="audio-actions">
                        <a href="{{ url_for('static.generated_audio', filename=current_file.audio_filename) }}" download class="btn btn-outline">
                            <i class="bi bi-download"></i>
                            Download
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="workflow-step">
                <div class="step-header">
                    <h3><i class="bi bi-chat-dots"></i> Chat with Document</h3>
                </div>
                <div class="step-content">
                    <button class="btn btn-outline w-100" onclick="openChat()">
                        <i class="bi bi-chat"></i>
                        Open Chat
                    </button>
                </div>
            </div>
        </div>

        <div id="loading-overlay" class="loading-overlay" style="display: none;">
            <div class="spinner"></div>
            <p id="loading-text">Processing...</p>
        </div>

        <div id="progress-modal" class="progress-modal hidden">
            <div class="progress-card">
                <div id="progress-icon" class="progress-icon processing">
                    <i class="bi bi-hourglass-split"></i>
                </div>
                <h3 id="progress-title" class="progress-title">Processing...</h3>
                <p id="progress-subtitle" class="progress-subtitle">Please wait</p>
                <div class="progress-steps" id="progress-steps">
                    <div class="progress-step active" data-step="1" title="Ingest"></div>
                    <div class="progress-step" data-step="2" title="Summary"></div>
                    <div class="progress-step" data-step="3" title="Script"></div>
                    <div class="progress-step" data-step="4" title="Audio"></div>
                </div>
                <div class="progress-bar-container">
                    <div id="progress-bar" class="progress-bar"></div>
                </div>
                <p id="progress-status" class="text-muted small">Step 1 of 4</p>
                <button id="progress-cancel" class="btn btn-ghost btn-sm mt-3" onclick="cancelCurrentTask()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="sidebar" class="library-sidebar">
        <h4>Library</h4>
        <div class="library-list">
            {% for file in all_files %}
            <div class="library-item-row">
                <a href="/?file={{ file.id }}" class="library-item {% if file.id == current_file.id %}active{% endif %}">
                    <i class="bi bi-file-earmark-text"></i>
                    <span>{{ file.filename[:18] }}{% if file.filename|length > 18 %}...{% endif %}</span>
                    {% if file.summary %}<i class="bi bi-check-circle-fill text-success ms-auto" title="Summary ready"></i>{% endif %}
                </a>
                <button class="btn btn-ghost btn-sm library-delete" onclick="event.preventDefault(); deleteFile({{ file.id }})" title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            {% endfor %}
        </div>
        <a href="{{ url_for('ragflow.ragflow_browser') }}" class="btn btn-outline w-100 mt-3">
            <i class="bi bi-cloud-download"></i>
            Import from Ragflow
        </a>
        <button class="btn btn-outline w-100 mt-2" onclick="window.location.href='/'">
            <i class="bi bi-plus-lg"></i>
            New Upload
        </button>
    </div>
    </div>
</div>
{% endif %}

<!-- Modals -->
<div class="modal-overlay" id="summary-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Summary</h3>
            <button class="btn btn-ghost" onclick="closeModal('summary-modal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="summary-text">{{ current_file.summary if current_file.summary else 'No summary yet.' }}</div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="original-text-modal" style="display: none;">
    <div class="modal-content modal-lg" style="max-width: 900px;">
        <div class="modal-header">
            <h3>Original Text</h3>
            <button class="btn btn-ghost" onclick="closeModal('original-text-modal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body" style="white-space: pre-wrap; font-size: 13px; line-height: 1.6;">
            <div id="original-text-content">{{ current_file.text }}</div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="transcript-modal" style="display: none;">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3>Podcast Script</h3>
            <button class="btn btn-ghost" onclick="closeModal('transcript-modal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body">
            <textarea class="form-control" id="transcript-edit" rows="15">{{ current_file.transcript if current_file.transcript else '' }}</textarea>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="saveAndGenerate()">
                <i class="bi bi-play-circle"></i>
                Save & Generate Audio
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="chat-modal" style="display: none;">
    <div class="modal-content modal-lg" style="max-width: 700px; height: 80vh;">
        <div class="modal-header">
            <h3><i class="bi bi-chat-dots"></i> Chat with Document</h3>
            <button class="btn btn-ghost" onclick="closeModal('chat-modal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body" style="display: flex; flex-direction: column; padding: 0;">
            <div class="chat-options" style="padding: 12px 20px; border-bottom: 1px solid var(--border);">
                <label class="chat-toggle">
                    <input type="checkbox" id="ragflow-toggle">
                    <span>Include Ragflow context</span>
                </label>
                <select id="ragflow-dataset" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                    <option value="">Loading datasets...</option>
                </select>
            </div>
            <div id="chat-messages" class="chat-messages" style="flex: 1; overflow-y: auto; padding: 20px;">
                <div class="chat-message assistant">
                    <p>Ask me anything about this document. I can also pull relevant context from your Ragflow knowledge base if enabled.</p>
                </div>
            </div>
            <div class="chat-input-container" style="padding: 16px 20px; border-top: 1px solid var(--border);">
                <div class="input-group">
                    <input type="text" id="chat-input" class="form-control" placeholder="Ask a question about this document..." onkeypress="if(event.key==='Enter')sendChat()">
                    <button class="btn btn-primary" onclick="sendChat()">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const CURRENT_FILE_ID = {{ current_file.id if current_file else 'null' }};
const AUTO_GENERATE = {{ auto_generate | tojson }};
const HAS_SUMMARY = {{ 'true' if current_file and current_file.summary else 'false' }};

document.addEventListener('DOMContentLoaded', function() {
    initRagflowDatasets();
    initFileUpload();
    initMobileLibrary();
    initAutoGenerate();
    initSidebar();
    
    // Pre-load chat datasets
    if (document.getElementById('chat-modal')) {
        loadRagflowDatasetsForChat();
    }
});

function initRagflowDatasets() {
    fetch('{{ url_for("ragflow.ragflow_datasets") }}')
        .then(r => r.json())
        .then(data => {
            const select = document.getElementById('ragflow-dataset-select');
            if (select && data.datasets) {
                select.innerHTML = data.datasets.map(d =>
                    `<option value="${d.id}">${d.name}</option>`
                ).join('');
            }
        });
    
    document.getElementById('upload_to_ragflow')?.addEventListener('change', function() {
        const select = document.getElementById('ragflow-dataset-select');
        if (select) select.style.display = this.checked ? 'block' : 'none';
    });
}

function initFileUpload() {
    const fileInput = document.getElementById('file-input');
    const uploadForm = document.getElementById('upload-form');
    
    fileInput?.addEventListener('change', function() {
        if (this.files.length > 0) {
            // Show loading state
            const btn = fileInput.nextElementSibling;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
            btn.disabled = true;
            
            uploadForm.submit();
        }
    });
    
    // Handle upload errors
    uploadForm?.addEventListener('submit', function(e) {
        // Check if file is valid
        const fileInput = document.getElementById('file-input');
        if (!fileInput || !fileInput.files.length) {
            e.preventDefault();
            alert('Please select a PDF file to upload.');
            return;
        }
        
        const file = fileInput.files[0];
        if (!file.name.toLowerCase().endsWith('.pdf')) {
            e.preventDefault();
            alert('Only PDF files are supported.');
            return;
        }
    });
}

function initMobileLibrary() {
    if (window.innerWidth <= 768) {
        document.querySelectorAll('.library-sidebar').forEach(sidebar => {
            sidebar.classList.remove('visible');
            sidebar.classList.add('collapsed');
        });
    }
}

function initSidebar() {
    const sidebarToggle = document.getElementById('sidebar-toggle');
    sidebarToggle?.addEventListener('click', window.toggleSidebar);
}

function initAutoGenerate() {
    const autoGenerate = AUTO_GENERATE;
    const hasSummary = HAS_SUMMARY === 'true';

    if (autoGenerate === 'summary' && !hasSummary) {
        globalInlineMode = true;
        const url = new URL(window.location);
        url.searchParams.delete('generate');
        url.searchParams.delete('inline');
        window.history.replaceState({}, '', url.toString());
        setTimeout(() => streamSummary(), 500);
    } else if (hasSummary && autoGenerate) {
        const url = new URL(window.location);
        url.searchParams.delete('generate');
        url.searchParams.delete('inline');
        window.history.replaceState({}, '', url.toString());
    }
}
</script>
{% endblock %}
