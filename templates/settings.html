{% extends "base.html" %}

{% block title %}Settings - AudioPaper{% endblock %}

{% block header_actions %}
<div class="header-actions">
    <a href="{{ url_for('files.index') }}" class="btn btn-ghost" title="Library">
        <i class="bi bi-house"></i>
    </a>
</div>
{% endblock %}

{% block content %}
<div class="settings-container">
    <div class="settings-card">
        <div class="settings-header">
            <h1><i class="bi bi-gear"></i> Settings</h1>
            <p class="text-muted">API keys and models are configured via .env file</p>
        </div>

        <form action="{{ url_for('settings.settings') }}" method="post" class="settings-form">
            <div class="config-info">
                <h5><i class="bi bi-info-circle"></i> Configuration</h5>
                <ul>
                    <li><strong>NanoGPT:</strong> Text generation (summaries, transcripts, chat)</li>
                    <li><strong>DeepInfra:</strong> Text-to-speech (Kokoro)</li>
                    <li><strong>Ragflow:</strong> Document browser</li>
                    <li><strong>Models:</strong> All configured in .env file</li>
                </ul>
            </div>

            <div class="settings-section">
                <h3>Prompts</h3>
                <div class="form-group">
                    <label for="summary_prompt">Summary Prompt</label>
                    <textarea class="form-control" id="summary_prompt" name="summary_prompt" rows="3">{{ settings.summary_prompt }}</textarea>
                </div>
                <div class="form-group">
                    <label for="transcript_prompt">Transcript Prompt</label>
                    <textarea class="form-control" id="transcript_prompt" name="transcript_prompt" rows="5">{{ settings.transcript_prompt }}</textarea>
                </div>
            </div>

            <div class="settings-section">
                <h3>Podcast Settings</h3>
                <div class="form-group">
                    <label for="transcript_length">Podcast Length</label>
                    <select class="form-select" id="transcript_length" name="transcript_length">
                        <option value="short" {% if settings.transcript_length == 'short' %}selected{% endif %}>Short (2-3 min)</option>
                        <option value="medium" {% if settings.transcript_length == 'medium' or not settings.transcript_length %}selected{% endif %}>Medium (5-7 min)</option>
                        <option value="long" {% if settings.transcript_length == 'long' %}selected{% endif %}>Long (10+ min)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tts_host_voice">Host Voice</label>
                    <div class="input-group">
                        <select class="form-select" id="tts_host_voice" name="tts_host_voice">
                            {% for voice_id, voice_desc in voices %}
                                <option value="{{ voice_id }}" {% if voice_id == settings.tts_host_voice %}selected{% endif %}>{{ voice_desc }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-outline play-sample-button" type="button" data-target-select="tts_host_voice">
                            <i class="bi bi-volume-up-fill"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="tts_expert_voice">Expert Voice</label>
                    <div class="input-group">
                        <select class="form-select" id="tts_expert_voice" name="tts_expert_voice">
                            {% for voice_id, voice_desc in voices %}
                                <option value="{{ voice_id }}" {% if voice_id == settings.tts_expert_voice %}selected{% endif %}>{{ voice_desc }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-outline play-sample-button" type="button" data-target-select="tts_expert_voice">
                            <i class="bi bi-volume-up-fill"></i>
                        </button>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-save"></i>
                Save Changes
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.play-sample-button').forEach(button => {
        button.addEventListener('click', function() {
            const selectId = this.getAttribute('data-target-select');
            const voice = document.getElementById(selectId).value;
            
            fetch('/play_voice_sample', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({voice: voice})
            })
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                const audio = new Audio(data.audio_url);
                audio.play();
            })
            .catch(err => alert('Error: ' + err));
        });
    });
});
</script>
{% endblock %}
